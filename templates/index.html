<!DOCTYPE html>
<html>
<head>
    <title>Google Maps to Anime</title>
    <!-- Your existing, working CSS is perfect. Omitted for brevity. -->
    <style>
        * { box-sizing: border-box; } body { font-family: sans-serif; margin: 0; padding: 10px; display: flex; flex-direction: column; height: 100vh; background-color: #202124; } #app-header { color: #e8eaed; text-align: center; margin-bottom: 5px; } #app-header h1 { margin: 0 0 5px 0; font-size: 24px; font-weight: bold; } #credit-line { display: inline-flex; justify-content: center; align-items: center; gap: 8px; font-size: 20px; font-weight: 500; } #credit-line img { height: 24px; } #view-titles-container { display: flex; gap: 10px; color: #e8eaed; font-weight: 500; font-size: 16px; margin-bottom: 10px; } .view-title-left, .view-title-right { flex: 1; text-align: center; } #main-content { flex-grow: 1; display: flex; overflow: hidden; gap: 10px; margin-bottom: 10px; } #pano-container, #anime-container { flex: 1; display: flex; justify-content: center; align-items: center; background-color: #333; overflow: hidden; border-radius: 8px; position: relative; } #pano { width: 100%; height: 100%; border-radius: 8px; } #anime-image { width: 100%; height: 100%; object-fit: cover; display: none; border-radius: 8px; } #anime-container[data-error]::before { content: attr(data-error); padding: 20px; text-align: center; font-size: 1.1em; color: #ff8a8a; } #search-container { padding: 10px; background-color: #3c4043; display: flex; align-items: center; justify-content: center; gap: 15px; box-shadow: 0 -2px 5px rgba(0,0,0,0.2); z-index: 10; border-radius: 8px; } .search-group { display: flex; align-items: center; gap: 10px; } #location-input { width: 300px; padding: 10px; font-size: 16px; border: 1px solid #5f6368; border-radius: 4px; background-color: #202124; color: #e8eaed; } .coord-input { width: 120px; padding: 10px; font-size: 16px; border: 1px solid #5f6368; border-radius: 4px; background-color: #202124; color: #e8eaed; } .go-button { padding: 10px 20px; font-size: 16px; font-weight: bold; color: white; background-color: #4285F4; border: none; border-radius: 4px; cursor: pointer; } .separator { border-left: 2px solid #5f6368; height: 30px; } .loader { border: 8px solid #5f6368; border-radius: 50%; border-top: 8px solid #4285F4; width: 60px; height: 60px; animation: spin 2s linear infinite; display: none; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } .pac-container { background-color: #202124; border-radius: 4px; border: 1px solid #5f6368; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3); bottom: 60px !important; top: auto !important; } .pac-item { padding: 10px; font-size: 16px; color: #e8eaed; cursor: pointer; border-top: 1px solid #3c4043; } .pac-item-query { font-weight: bold; color: #e8eaed; }
    </style>
</head>
<body>
    <header id="app-header">
        <h1>Street2Anime</h1>
        <div id="credit-line">
            <span>Made with ♥️ by</span>
            <img src="{{ url_for('static', filename='dev-logo.png') }}" alt="Dev Logo">
            <span>Nitin Tiwari</span>
        </div>
    </header>
    <div id="view-titles-container">
        <div class="view-title-left">Google Maps Street View</div>
        <div class="view-title-right">Generated by Gemini</div>
    </div>
    <div id="main-content">
        <div id="pano-container"><div id="pano"></div></div>
        <div id="anime-container">
            <div id="loader" class="loader"></div>
            <img id="anime-image" alt="Anime Version">
        </div>
    </div>
    <div id="search-container">
        <div class="search-group">
            <input type="text" id="location-input" placeholder="Search by Landmark (e.g., Eiffel Tower)">
        </div>
        <div class="separator"></div>
        <div class="search-group">
            <input type="number" id="lat-input" class="coord-input" placeholder="Latitude">
            <input type="number" id="lng-input" class="coord-input" placeholder="Longitude">
            <button id="coords-button" class="go-button">Go</button>
        </div>
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key={{ maps_api_key }}&libraries=places&callback=initMap" async defer></script>

    <script>
        let panorama;
        const backendUrl = '/generate-anime';
        let isGenerating = false;
        let debounceTimeout;
        let lastGenerationTime = 0;
        const GENERATION_COOLDOWN = 4000; // 4 second cooldown

        function initMap() {
            const startPosition = { lat: 37.8087164, lng: -122.4754462 };
            panorama = new google.maps.StreetViewPanorama(document.getElementById('pano'), {
                position: startPosition,
                pov: { heading: 319.37, pitch: 10 },
                zoom: 1.5,
                addressControl: false, linksControl: true, panControl: true, enableCloseButton: false
            });

            // Set up search and validation logic
            const streetViewService = new google.maps.StreetViewService();
            const input = document.getElementById('location-input');
            const autocomplete = new google.maps.places.Autocomplete(input);
            autocomplete.setFields(['geometry', 'name']);
            autocomplete.addListener('place_changed', () => {
                const place = autocomplete.getPlace();
                if (place.geometry && place.geometry.location) {
                    findAndSetPanorama(place.geometry.location);
                }
            });

            document.getElementById('coords-button').addEventListener('click', handleCoordsSearch);

            // --- THIS IS THE FINAL, ROBUST TRIGGER LOGIC ---

            // 1. The 'idle' event is the main trigger. It fires only when the map is fully loaded and stable.
            // This is the key to preventing the "request storm".
            panorama.addListener('idle', () => {
                console.log("Map is idle and stable. Requesting generation.");
                fetchDataAndGenerate();
            });

            // 2. We keep a debounced 'pov_changed' listener for the smooth interactive feeling
            // while the user is just looking around, but not after a major position change.
            panorama.addListener('pov_changed', () => {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(fetchDataAndGenerate, 2000); // A generous 2-second delay
            });
        }

        function handleCoordsSearch() {
            const latVal = parseFloat(document.getElementById('lat-input').value);
            const lngVal = parseFloat(document.getElementById('lng-input').value);
            if (isNaN(latVal) || isNaN(lngVal)) {
                alert("Please enter valid numbers for Latitude and Longitude.");
                return;
            }
            document.getElementById('location-input').value = '';
            findAndSetPanorama({ lat: latVal, lng: lngVal });
        }

        function findAndSetPanorama(location) {
            const streetViewService = new google.maps.StreetViewService();
            streetViewService.getPanorama({ location: location, radius: 50 }, (data, status) => {
                if (status === google.maps.StreetViewStatus.OK) {
                    // This just moves the map. The 'idle' event will handle the generation.
                    panorama.setPosition(data.location.latLng);
                } else {
                    alert("Sorry, there is no Street View imagery available for this location.");
                }
            });
        }

        async function fetchDataAndGenerate() {
            const now = Date.now();
            if (isGenerating || (now - lastGenerationTime < GENERATION_COOLDOWN)) {
                console.log(`Skipping generation: In cooldown.`);
                return;
            }
            if (!panorama) return;

            const position = panorama.getPosition();
            const pov = panorama.getPov();
            if (!position || !pov) return;

            const fov = 180 / Math.pow(2, panorama.getZoom());
            const data = { lat: position.lat(), lng: position.lng(), heading: pov.heading, pitch: pov.pitch, fov: fov };
            await generateAnime(data);
        }

        async function generateAnime(locationData) {
            isGenerating = true; 
            const animeImage = document.getElementById('anime-image');
            const animeContainer = document.getElementById('anime-container');
            const loader = document.getElementById('loader');
            loader.style.display = 'block';
            animeImage.style.display = 'none';
            animeContainer.removeAttribute('data-error');
            try {
                const response = await fetch(backendUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(locationData),
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || `HTTP error! Status: ${response.status}`);
                animeImage.src = result.image;
            } catch (error) {
                console.error('Error generating anime:', error);
                animeContainer.setAttribute('data-error', error.message);
            } finally {
                isGenerating = false; 
                lastGenerationTime = Date.now();
                loader.style.display = 'none';
                if (!animeContainer.hasAttribute('data-error')) {
                    animeImage.style.display = 'block';
                }
            }
        }
    </script>
</body>
</html>